<template>
  <div>
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Usuários Externos</h1>
    </div>

    <!-- Loading state -->
    <div v-if="loading" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-gray-600">Carregando...</p>
    </div>

    <!-- Error state -->
    <div v-else-if="error" class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
      <Icon name="mdi:alert-circle" class="w-12 h-12 text-red-500 mx-auto mb-3" />
      <p class="text-red-700 font-medium">{{ error }}</p>
      <button
        @click="loadData"
        class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
      >
        Tentar Novamente
      </button>
    </div>

    <div v-else>
      <!-- Filtros -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
            <select v-model="filters.period" @change="loadData" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="all">Todo o período</option>
              <option value="30">Últimos 30 dias</option>
              <option value="60">Últimos 60 dias</option>
              <option value="90">Últimos 90 dias</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
            <select v-model="filters.userId" @change="loadData" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="">Todos os usuários</option>
              <option v-for="user in externalUsers" :key="user.id" :value="user.id">
                {{ user.name }} ({{ user.email }})
              </option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de transação</label>
            <select v-model="filters.type" @change="loadData" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="">Todos os tipos</option>
              <option value="EXPENSE">Despesas</option>
              <option value="INCOME">Receitas</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Lista de Usuários -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Gerenciar Usuários Externos</h3>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cadastro</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transações</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categorias</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="user in externalUsers" :key="user.id">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {{ user.name }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ user.email }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ formatDate(user.createdAt) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ user._count.transactions }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ user._count.categories }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <button
                    @click="openConvertModal(user)"
                    class="text-blue-600 hover:text-blue-900"
                  >
                    Converter para Aluno
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div v-if="externalUsers.length === 0" class="text-center py-8">
          <p class="text-gray-500">Nenhum usuário externo encontrado</p>
        </div>
      </div>

      <!-- Estatísticas -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-2xl font-bold text-gray-900">{{ stats.totalUsers }}</div>
          <div class="text-sm text-gray-500">Usuários Externos</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-2xl font-bold text-green-600">R$ {{ formatCurrency(stats.totalIncome) }}</div>
          <div class="text-sm text-gray-500">Total Receitas</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-2xl font-bold text-red-600">R$ {{ formatCurrency(stats.totalExpense) }}</div>
          <div class="text-sm text-gray-500">Total Despesas</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-2xl font-bold" :class="stats.balance >= 0 ? 'text-green-600' : 'text-red-600'">
            R$ {{ formatCurrency(stats.balance) }}
          </div>
          <div class="text-sm text-gray-500">Saldo</div>
        </div>
      </div>

      <!-- Tabela de Transações -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Transações dos Usuários Externos</h3>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="transaction in transactions" :key="transaction.id">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div>
                    <div class="text-sm font-medium text-gray-900">{{ transaction.user.name }}</div>
                    <div class="text-sm text-gray-500">{{ transaction.user.email }}</div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ transaction.description }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ transaction.category?.name || '-' }}
                  <span v-if="transaction.subcategory" class="text-gray-500">/ {{ transaction.subcategory.name }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span :class="[
                    'px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full',
                    transaction.type === 'INCOME' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  ]">
                    {{ transaction.type === 'INCOME' ? 'Receita' : 'Despesa' }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <span :class="[
                    'font-medium',
                    transaction.type === 'INCOME' ? 'text-green-600' : 'text-red-600'
                  ]">
                    {{ transaction.type === 'INCOME' ? '+' : '-' }} R$ {{ formatCurrency(transaction.amount) }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ formatDate(transaction.date) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div v-if="transactions.length === 0" class="text-center py-8">
          <p class="text-gray-500">Nenhuma transação encontrada para os filtros selecionados</p>
        </div>
      </div>
    </div>

    <!-- Modal de Conversão -->
    <div v-if="showConvertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Converter para Aluno</h3>

        <div class="mb-4">
          <p class="text-sm text-gray-600 mb-2">
            Converter <strong>{{ selectedUser?.name }}</strong> de participante externo para aluno.
          </p>
          <p class="text-sm text-gray-500">
            O usuário será associado a uma turma e receberá as categorias padrão de aluno (se ainda não tiver).
          </p>
        </div>

        <div class="mb-4">
          <label for="turmaSelect" class="block text-sm font-medium text-gray-700 mb-2">
            Selecione a turma
          </label>
          <select
            v-model="convertForm.turmaId"
            id="turmaSelect"
            class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
            required
          >
            <option value="">Selecione uma turma</option>
            <option v-for="turma in turmas" :key="turma.id" :value="turma.id">
              {{ turma.name }}
            </option>
          </select>
        </div>

        <div v-if="convertError" class="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-md">
          {{ convertError }}
        </div>

        <div class="flex justify-end space-x-3">
          <button
            @click="closeConvertModal"
            :disabled="converting"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Cancelar
          </button>
          <button
            @click="convertToStudent"
            :disabled="!convertForm.turmaId || converting"
            class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 disabled:opacity-50"
          >
            {{ converting ? 'Convertendo...' : 'Converter' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
definePageMeta({
  middleware: 'auth',
  layout: 'admin'
})

const externalUsers = ref([])
const transactions = ref([])
const turmas = ref([])
const stats = ref({
  totalUsers: 0,
  totalIncome: 0,
  totalExpense: 0,
  balance: 0
})

const filters = ref({
  period: 'all',
  userId: '',
  type: ''
})

const showConvertModal = ref(false)
const selectedUser = ref(null)
const convertForm = ref({
  turmaId: ''
})
const converting = ref(false)
const convertError = ref('')
const loading = ref(false)
const error = ref('')

const loadData = async () => {
  loading.value = true
  error.value = ''

  try {
    // Carrega usuários externos
    const usersResponse = await $fetch('/api/admin/external-users')
    externalUsers.value = usersResponse || []

    // Carrega turmas
    const turmasResponse = await $fetch('/api/turmas')
    turmas.value = turmasResponse || []

    // Carrega transações com filtros
    const queryParams = new URLSearchParams()
    if (filters.value.period !== 'all') queryParams.append('period', filters.value.period)
    if (filters.value.userId) queryParams.append('userId', filters.value.userId)
    if (filters.value.type) queryParams.append('type', filters.value.type)

    const transactionsResponse = await $fetch(`/api/admin/external-transactions?${queryParams}`)
    transactions.value = transactionsResponse?.transactions || []
    stats.value = transactionsResponse?.stats || {
      totalUsers: 0,
      totalIncome: 0,
      totalExpense: 0,
      balance: 0
    }
  } catch (err: any) {
    console.error('Erro ao carregar dados:', err)
    error.value = err.data?.message || err.message || 'Erro ao carregar dados'
  } finally {
    loading.value = false
  }
}

const openConvertModal = (user: any) => {
  selectedUser.value = user
  convertForm.value.turmaId = ''
  convertError.value = ''
  showConvertModal.value = true
}

const closeConvertModal = () => {
  showConvertModal.value = false
  selectedUser.value = null
  convertForm.value.turmaId = ''
  convertError.value = ''
}

const convertToStudent = async () => {
  if (!selectedUser.value || !convertForm.value.turmaId) return

  converting.value = true
  convertError.value = ''

  try {
    await $fetch(`/api/admin/external-users/${selectedUser.value.id}`, {
      method: 'PUT',
      body: {
        role: 'STUDENT',
        turmaId: convertForm.value.turmaId
      }
    })

    // Recarrega os dados
    await loadData()

    // Fecha o modal
    closeConvertModal()
  } catch (error: any) {
    convertError.value = error.data?.message || 'Erro ao converter usuário'
  } finally {
    converting.value = false
  }
}

const formatCurrency = (value: number) => {
  return new Intl.NumberFormat('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value)
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('pt-BR')
}

// Carrega dados ao montar
onMounted(() => {
  loadData()
})
</script>