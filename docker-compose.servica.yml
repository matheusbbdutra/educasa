version: '3.8'

services:
  # Nuxt Web App
  web-app:
    build:
      context: ./web-app
      dockerfile: Dockerfile
    image: educasa/web-app:latest
    container_name: educasa-web-app
    restart: unless-stopped

    environment:
      - NODE_ENV=production

      # Turso Cloud (modo cloud, sem embedded replica)
      - TURSO_DATABASE_URL=${TURSO_DATABASE_URL}
      - TURSO_AUTH_TOKEN=${TURSO_AUTH_TOKEN}

      # JWT
      - NUXT_JWT_SECRET=${JWT_SECRET}

      # Go Worker API
      - GO_WORKER_API_URL=http://go-worker:8080
      - GO_WORKER_API_KEY=${GO_WORKER_API_KEY}

      # Sentry (opcional)
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_DEBUG=${SENTRY_DEBUG:-false}
      - SENTRY_LOG_LEVEL=${SENTRY_LOG_LEVEL:-error}

      # Timezone
      - TZ=America/Sao_Paulo

    volumes:
      - ./uploads:/app/uploads

    networks:
      - educasa-network

    labels:
      # Traefik labels (para Traefik externo)
      - "traefik.enable=true"
      - "traefik.http.routers.educasa.rule=Host(`educasa.app.br`)"
      - "traefik.http.routers.educasa.entrypoints=websecure"
      - "traefik.http.routers.educasa.tls=true"
      - "traefik.http.routers.educasa.tls.certresolver=letsencrypt"
      - "traefik.http.services.educasa.loadbalancer.server.port=3000"

      # Router www (redirecionamento)
      - "traefik.http.routers.educasa-www.rule=Host(`educasa.mdutra.dev`)"
      - "traefik.http.routers.educasa-www.entrypoints=websecure"
      - "traefik.http.routers.educasa-www.tls=true"
      - "traefik.http.routers.educasa-www.tls.certresolver=letsencrypt"
      - "traefik.http.routers.educasa-www.middlewares=redirect-www"

      # Middleware de redirecionamento www â†’ non-www
      - "traefik.http.middlewares.redirect-www.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.redirect-www.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.redirect-www.redirectregex.permanent=true"

    depends_on:
      - go-worker

  # Go Worker
  go-worker:
    build:
      context: ./microservice-go
      dockerfile: Dockerfile
    image: educasa/go-worker:latest
    container_name: educasa-go-worker
    restart: unless-stopped

    environment:
      # Database (modo cloud)
      - GO_DB_MODE=cloud
      - TURSO_DATABASE_URL=${TURSO_DATABASE_URL}
      - TURSO_AUTH_TOKEN=${TURSO_AUTH_TOKEN}

      # SMTP (Zeptomail)
      - SMTP_HOST=${SMTP_HOST:-smtp.zeptomail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-emailapikey}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL:-noreply@educasa.app.br}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Educa.SA}

      # API Security
      - GO_WORKER_API_KEY=${GO_WORKER_API_KEY}

      # Worker Configuration
      - BATCH_SIZE=${BATCH_SIZE:-20}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-3}
      - WORKER_POLL_INTERVAL=${WORKER_POLL_INTERVAL:-1m}
      - JOB_TIMEOUT_MINUTES=${JOB_TIMEOUT_MINUTES:-30}

      # Scheduler
      - ENABLE_SCHEDULER=${ENABLE_SCHEDULER:-true}
      - MONTHLY_CRON=${MONTHLY_CRON:-0 0 1 * *}

      # Server
      - SERVER_PORT=${SERVER_PORT:-8080}
      - SERVER_HOST=${SERVER_HOST:-0.0.0.0}

      # Logging
      - GO_LOG_LEVEL=${GO_LOG_LEVEL:-info}
      - GO_LOG_FORMAT=${GO_LOG_FORMAT:-json}

      # Timezone
      - TZ=America/Sao_Paulo

    volumes:
      - worker-exports:/tmp/exports

    networks:
      - educasa-network

    labels:
      # Traefik labels (para Traefik externo)
      - "traefik.enable=true"
      - "traefik.http.routers.go-worker.rule=Host(`worker.mdutra.dev`)"
      - "traefik.http.routers.go-worker.entrypoints=websecure"
      - "traefik.http.routers.go-worker.tls=true"
      - "traefik.http.routers.go-worker.tls.certresolver=letsencrypt"
      - "traefik.http.services.go-worker.loadbalancer.server.port=8080"

networks:
  educasa-network:
    driver: bridge

volumes:
  worker-exports:
    driver: local
